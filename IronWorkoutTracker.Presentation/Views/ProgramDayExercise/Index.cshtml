@{
    Layout = "_ApplicationLayout";
}

@model IronWorkoutTracker.Presentation.ViewModels.ProgramDayExerciseIndexViewModel

<div class="mb-4">
    <a asp-controller="WorkoutProgram" 
       asp-action="Details" 
       asp-route-id="@Model.ProgramDay.WorkoutProgramId"
       class="btn btn-secondary">
        ‚Üê Back to Program
    </a>
</div>
<div class="d-flex justify-content-between  mb-5">
    <h2>@Model.ProgramDay.Title - Exercises</h2>

    <button type="button"
            class="btn btn-success mb-3"
            data-action="Create"
            data-controller="ProgramDayExercise"
            data-program-day-id="@Model.ProgramDay.ProgramDayId"
            data-bs-toggle="modal"
            data-bs-target="#GlobalModal">
        <i class="bi bi-plus"></i> Add Exercise
    </button>
</div>


<!-- Modal -->
<div class="modal fade" id="GlobalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" id="modalContent">
            <!-- Loaded via AJAX -->
        </div>
    </div>
</div>
@if (Model.Exercises.Any())
{
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Exercise</th>
                    <th>Category</th>
                    <th>Training Style</th>
                    <th>Note</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var exercise in Model.Exercises)
            {
                <tr>
                    <td>
                        <strong>@exercise.Exercise?.Name</strong>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(exercise.Exercise?.Category))
                        {
                            <span class="badge bg-info">@exercise.Exercise.Category</span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(exercise.TrainingStyle))
                        {
                            <code>@exercise.TrainingStyle</code>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(exercise.Note))
                        {
                            <small>@exercise.Note</small>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-primary"
                                data-action="EditModal"
                                data-controller="ProgramDayExercise"
                                data-id="@exercise.ProgramDayExerciseId"
                                data-bs-toggle="modal"
                                data-bs-target="#GlobalModal">
                            <i class="bi bi-pencil"></i> Edit
                        </button>

                        <form asp-controller="ProgramDayExercise"
                              asp-action="Delete"
                              asp-route-id="@exercise.ProgramDayExerciseId"
                              method="post"
                              class="d-inline"
                              onsubmit="return confirm('Delete this exercise?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </form>
                    </td>
                    <td>
                        <button type="button"
                                class="btn btn-sm border-none"
                                data-bs-toggle="collapse"
                                data-bs-target="#sets-@exercise.ProgramDayExerciseId"
                                aria-expanded="false"
                                style="font-size: 1.3rem; border: none;">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </td>
                </tr>

                <!-- Accordion for Sets -->
                <tr>
                    <td colspan="6">
                        <div class="collapse" id="sets-@exercise.ProgramDayExerciseId">
                            <div class="p-3 bg-light border-top">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Sets for @exercise.Exercise?.Name</h6>
                                    <button type="button"
                                            class="btn btn-sm btn-success"
                                            data-action="Create"
                                            data-controller="ProgramDayExerciseSet"
                                            data-program-day-exercise-id="@exercise.ProgramDayExerciseId"
                                            data-bs-toggle="modal"
                                            data-bs-target="#GlobalModal">
                                        <i class="bi bi-plus"></i> Add Set
                                    </button>
                                </div>

                                @if (exercise.Sets?.Any() == true)
                                {
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Set #</th>
                                                    <th>Reps</th>
                                                    <th>Weight</th>
                                                    <th>Rest (sec)</th>
                                                    <th>RPE</th>
                                                    <th>Note</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            @foreach (var set in exercise.Sets.OrderBy(s => s.Order))
                                            {
                                                 var setIndex = exercise.Sets.Where(s => s.Order <= set.Order).Count();
                                                <tr>
                                                    <td>
                                                        <strong>@setIndex</strong>
                                                    </td>
                                                    <td>
                                                        @(set.Reps ?? 0)
                                                    </td>
                                                    <td>
                                                        @if (set.Weight.HasValue)
                                                        {
                                                            <text>@set.Weight kg</text>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (set.RestSeconds.HasValue)
                                                        {
                                                            <text>@set.RestSeconds</text>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (set.RPE.HasValue)
                                                        {
                                                            <text>@set.RPE</text>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(set.Note))
                                                        {
                                                            <small>@set.Note</small>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <button type="button"
                                                                class="btn btn-xs btn-primary"
                                                                data-action="EditModal"
                                                                data-controller="ProgramDayExerciseSet"
                                                                data-id="@set.ProgramDayExerciseSetId"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#GlobalModal">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>

                                                        <form asp-controller="ProgramDayExerciseSet"
                                                              asp-action="Delete"
                                                              asp-route-id="@set.ProgramDayExerciseSetId"
                                                              method="post"
                                                              class="d-inline"
                                                              onsubmit="return confirm('Delete this set?');">
                                                            <button type="submit" class="btn btn-xs btn-danger">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info mb-0">
                                        No sets added yet.
                                    </div>
                                }
                            </div>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        No exercises added yet. Click "Add Exercise" to get started.
    </div>
}
